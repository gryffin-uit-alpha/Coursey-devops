name: CI/CD Pipeline
on:
  push:
    branches:
      - main
  workflow_dispatch:

env:
  AWS_REGION: us-east-1 
  S3_BUCKET_NAME: coursey-project 
  ECR_REPOSITORY_PHP: coursey/php
  ECR_REPOSITORY_PYTHON: coursey/python
  ECR_REPOSITORY_NGINX: coursey/nginx
  ECR_REPOSITORY_MYSQL: coursey/mysql


jobs:
    sonar-scan:
        runs-on: ubuntu-latest
        steps:
            - name: Checkout Code
              uses: actions/checkout@v3
              with:
                fetch-depth: 0

            - name: Set up JDK 17
              uses: actions/setup-java@v3
              with:
                java-version: '17'
                distribution: 'temurin'

            - name: SonarQube Scan
              uses: SonarSource/sonarqube-scan-action@master
              env:
                SONAR_HOST_URL: ${{ secrets.SONAR_HOST_URL }}
                SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}

            - name: SonarQube Quality Gate
              uses: SonarSource/sonarqube-quality-gate-action@master
              timeout-minutes: 5
              env:
                SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
    deploy-frontend:
        name: Deploy Frontend (S3)
        runs-on: ubuntu-latest
        needs: sonar-scan 
        steps:
        - name: Checkout code
          uses: actions/checkout@v4
        - name: Configure AWS Credentials
          uses: aws-actions/configure-aws-credentials@v4
          with:
            aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
            aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
            aws-region: ${{ env.AWS_REGION }}
        - name: Setup Node.js
          uses: actions/setup-node@v4
          with:
            node-version: 18

        - name: Install & Build
          working-directory: ./front-end
          env:
            CI: false
          run: |
            npm install
            npm run build

        - name: Sync build to S3
          run: |
            aws s3 sync ./front-end/build/ s3://${{ env.S3_BUCKET_NAME }} --delete

    build-push-image:
        name: Build & Push Backend (ECR)
        runs-on: ubuntu-latest
        needs: sonar-scan 
        outputs:
            image_tag: ${{ steps.define_tag.outputs.tag }} 
        steps:
        - name: Checkout code
          uses: actions/checkout@v4

        - name: Configure AWS Credentials
          uses: aws-actions/configure-aws-credentials@v4
          with:
            aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
            aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
            aws-region: ${{ env.AWS_REGION }}

        - name: Login to Amazon ECR
          uses: aws-actions/amazon-ecr-login@v2
          id: login-ecr

        - name: Define Image Tag
          id: define_tag
          run: echo "tag=$(echo $GITHUB_SHA | cut -c 1-7)" >> $GITHUB_OUTPUT
 
        - name: Build, Tag, and Push PHP Image
          env:
            ECR_REGISTRY: ${{ steps.login-ecr.outputs.registry }}
            IMAGE_NAME: ${{ env.ECR_REPOSITORY_PHP }}
            IMAGE_TAG: ${{ steps.define_tag.outputs.tag }}
          run: |
              docker build -t $ECR_REGISTRY/$IMAGE_NAME:$IMAGE_TAG -f back-end/php/Dockerfile ./back-end
              docker push $ECR_REGISTRY/$IMAGE_NAME:$IMAGE_TAG

        - name: Build, Tag, and Push Python Image
          env:
            ECR_REGISTRY: ${{ steps.login-ecr.outputs.registry }}
            IMAGE_NAME: ${{ env.ECR_REPOSITORY_PYTHON }}
            IMAGE_TAG: ${{ steps.define_tag.outputs.tag }}
          run: |
              docker build -t $ECR_REGISTRY/$IMAGE_NAME:$IMAGE_TAG -f back-end/python/Dockerfile ./back-end
              docker push $ECR_REGISTRY/$IMAGE_NAME:$IMAGE_TAG
        - name: Build, Tag, and Push Nginx Image
          env:
            ECR_REGISTRY: ${{ steps.login-ecr.outputs.registry }}
            IMAGE_NAME: ${{ env.ECR_REPOSITORY_NGINX }}
            IMAGE_TAG: ${{ steps.define_tag.outputs.tag }}
          run: |
              docker build -t $ECR_REGISTRY/$IMAGE_NAME:$IMAGE_TAG -f back-end/nginx/Dockerfile ./back-end
              docker push $ECR_REGISTRY/$IMAGE_NAME:$IMAGE_TAG
        
        - name: Build, Tag, and Push MySQL Image
          env:
            ECR_REGISTRY: ${{ steps.login-ecr.outputs.registry }}
            IMAGE_NAME: ${{ env.ECR_REPOSITORY_MYSQL }}
            IMAGE_TAG: ${{ steps.define_tag.outputs.tag }}
          run: |
              docker build -t $ECR_REGISTRY/$IMAGE_NAME:$IMAGE_TAG -f back-end/mysql/Dockerfile ./back-end/mysql
              docker push $ECR_REGISTRY/$IMAGE_NAME:$IMAGE_TAG
